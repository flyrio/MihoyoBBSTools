name: MihoyoBBSTools Auto Run

on:
  schedule:
    # GitHub Actions 的 cron 使用 UTC 时间；此处 16:30 UTC = 中国时间 次日 00:30（约凌晨12点半）
    - cron: "30 16 * * *"
  workflow_dispatch:
    inputs:
      run_mode:
        description: "运行模式：single(单用户) / multi(多用户)"
        required: false
        default: "multi"

concurrency:
  group: mihoyo-bbs-auto-run
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      AUTO_MIHOYO_ALLOW_GITHUB_ACTIONS: "1"
      RUN_MODE: ${{ secrets.MIHOYO_RUN_MODE }}
      MIHOYO_CONFIG_YAML: ${{ secrets.MIHOYO_CONFIG_YAML }}
      MIHOYO_CONFIG_TGZ_BASE64: ${{ secrets.MIHOYO_CONFIG_TGZ_BASE64 }}
      MIHOYO_COOKIE: ${{ secrets.MIHOYO_COOKIE }}
      MIHOYO_STOKEN: ${{ secrets.MIHOYO_STOKEN }}
      MIHOYO_GAMES_CN: ${{ secrets.MIHOYO_GAMES_CN }}
      MIHOYO_PUSH_INI: ${{ secrets.MIHOYO_PUSH_INI }}
      MIHOYO_LOGGING_INI: ${{ secrets.MIHOYO_LOGGING_INI }}
      AutoMihoyoBBS_config_prefix: ${{ secrets.MIHOYO_CONFIG_PREFIX }}
      AutoMihoyoBBS_autorun: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set run mode (workflow_dispatch override)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_mode != '' }}
        run: echo "RUN_MODE=${{ inputs.run_mode }}" >> "$GITHUB_ENV"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Restore config files from secrets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p config

          if [ -n "${MIHOYO_CONFIG_TGZ_BASE64:-}" ]; then
            echo "${MIHOYO_CONFIG_TGZ_BASE64}" | base64 -d > /tmp/mhy_config.tgz
            tar -xzf /tmp/mhy_config.tgz -C config
          elif [ -n "${MIHOYO_CONFIG_YAML:-}" ]; then
            printf "%s" "${MIHOYO_CONFIG_YAML}" > config/config.yaml
          elif [ -n "${MIHOYO_COOKIE:-}" ]; then
            python - <<'PY'
          import os
          import yaml

          cookie = os.environ.get("MIHOYO_COOKIE", "")
          stoken = os.environ.get("MIHOYO_STOKEN", "")
          games_cn = os.environ.get("MIHOYO_GAMES_CN", "")

          if not cookie:
              raise SystemExit("MIHOYO_COOKIE is empty")

          enabled = set()
          for part in games_cn.replace(" ", ",").split(","):
              part = part.strip()
              if part:
                  enabled.add(part)

          def game_cfg(name: str):
              return {"checkin": name in enabled, "black_list": []}

          config = {
              "enable": True,
              "version": 15,
              "push": "",
              "account": {
                  "cookie": cookie,
                  "stuid": "",
                  "stoken": stoken or "",
                  "mid": "",
              },
              "device": {
                  "name": "Xiaomi MI 6",
                  "model": "Mi 6",
                  "id": "",
                  "fp": "",
              },
              "mihoyobbs": {
                  "enable": False,
                  "checkin": True,
                  "checkin_list": [5, 2],
                  "read": True,
                  "like": True,
                  "cancel_like": True,
                  "share": True,
              },
              "games": {
                  "cn": {
                      "enable": True,
                      "useragent": "Mozilla/5.0 (Linux; Android 12; Unspecified Device) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/103.0.5060.129 Mobile Safari/537.36",
                      "retries": 3,
                      "genshin": game_cfg("genshin"),
                      "honkai2": game_cfg("honkai2"),
                      "honkai3rd": game_cfg("honkai3rd"),
                      "tears_of_themis": game_cfg("tears_of_themis"),
                      "honkai_sr": game_cfg("honkai_sr"),
                      "zzz": game_cfg("zzz"),
                  },
                  "os": {
                      "enable": False,
                      "cookie": "",
                      "lang": "zh-cn",
                      "genshin": game_cfg("os.genshin"),
                      "honkai3rd": game_cfg("os.honkai3rd"),
                      "tears_of_themis": game_cfg("os.tears_of_themis"),
                      "honkai_sr": game_cfg("os.honkai_sr"),
                      "zzz": game_cfg("os.zzz"),
                  },
              },
              "cloud_games": {
                  "cn": {
                      "enable": False,
                      "genshin": {"enable": False, "token": ""},
                      "zzz": {"enable": False, "token": ""},
                  },
                  "os": {
                      "lang": "zh-cn",
                      "enable": False,
                      "genshin": {"enable": False, "token": ""},
                  },
              },
              "competition": {
                  "enable": False,
                  "genius_invokation": {
                      "enable": False,
                      "account": [],
                      "checkin": False,
                      "weekly": False,
                  },
              },
              "web_activity": {"enable": False, "activities": []},
          }

          with open("config/config.yaml", "w", encoding="utf-8") as f:
              yaml.safe_dump(config, f, allow_unicode=True, sort_keys=False)
          PY
          else
            echo "缺少配置：请在仓库 Secrets 中设置 MIHOYO_CONFIG_YAML / MIHOYO_CONFIG_TGZ_BASE64 / MIHOYO_COOKIE" >&2
            exit 1
          fi

          if [ -n "${MIHOYO_PUSH_INI:-}" ]; then
            printf "%s" "${MIHOYO_PUSH_INI}" > config/push.ini
          fi
          if [ -n "${MIHOYO_LOGGING_INI:-}" ]; then
            printf "%s" "${MIHOYO_LOGGING_INI}" > config/logging.ini
          fi

      - name: Run
        shell: bash
        run: |
          set -euo pipefail
          mode="${RUN_MODE:-multi}"
          if [ "${mode}" = "single" ]; then
            python main.py
          else
            python main_multi.py autorun
          fi
